USE DBMS;

CREATE TABLE PUBLISHER(
    NAME VARCHAR(20) NOT NULL PRIMARY KEY,
    ADDRESS VARCHAR(30) NOT NULL,
    PHONE VARCHAR(10) NOT NULL
);

CREATE TABLE BOOK(
    BOOK_ID INT NOT NULL PRIMARY KEY,
    TITLE VARCHAR(20) NOT NULL,
    PUBLISHER_NAME VARCHAR(20) NOT NULL FOREIGN KEY REFERENCES PUBLISHER(NAME)
);

CREATE TABLE BORROWER(
    CARD_NO INT NOT NULL PRIMARY KEY,
    NAME VARCHAR(20) NOT NULL,
    ADDRESS VARCHAR(30) NOT NULL,
    PHONE VARCHAR(10) NOT NULL
);

CREATE TABLE LIBRARY_BRANCH(
    BRANCH_ID INT NOT NULL PRIMARY KEY,
    BRANCH_NAME VARCHAR(20) NOT NULL,
    ADDRESS VARCHAR(30) NOT NULL
);

CREATE TABLE BOOK_AUTHORS(
    BOOK_ID INT NOT NULL FOREIGN KEY REFERENCES BOOK(BOOK_ID),
    AUTHOR_NAME VARCHAR(20) NOT NULL,
    PRIMARY KEY(BOOK_ID, AUTHOR_NAME)
);

CREATE TABLE BOOK_COPIES(
    BOOK_ID INT NOT NULL FOREIGN KEY REFERENCES BOOK(BOOK_ID),
    BRANCH_ID INT NOT NULL FOREIGN KEY REFERENCES LIBRARY_BRANCH(BRANCH_ID),
    NO_OF_COPIES INT NOT NULL,
    PRIMARY KEY(BOOK_ID, BRANCH_ID)
);

CREATE TABLE BOOK_LOANS(
    BOOK_ID INT NOT NULL FOREIGN KEY REFERENCES BOOK(BOOK_ID),
    BRANCH_ID INT NOT NULL FOREIGN KEY REFERENCES LIBRARY_BRANCH(BRANCH_ID),
    CARD_NO INT NOT NULL FOREIGN KEY REFERENCES BORROWER(CARD_NO),
    DATE_OUT DATE NOT NULL,
    DUE_DATE DATE NOT NULL,
    PRIMARY KEY(BOOK_ID, BRANCH_ID, CARD_NO)
);

INSERT INTO PUBLISHER VALUES
    ('Penguin India','Bangalore',9993042367),
    ('Macmillan Publishers','New Delhi',9745623412),
    ('Arihant Books','Mumbai',8763457891),
    ('Rupa Publications','New Delhi',9611067125),
    ('Scholastic India','Mumbai',7806041205);


INSERT INTO BOOK VALUES
    (1,'Data Structures','Penguin India'),
    (2,'Algorithms','Penguin India'),
    (3,'Discrete Mathematics','Macmillan Publishers'),
    (4,'DBMS','Arihant Books'),
    (5,'Linear Algebra','Rupa Publications');

INSERT INTO BOOK_AUTHORS VALUES
    (1,'Dinesh Singh'),
    (2,'Thomas Cormen'),
    (3,'Kenneth Rosen'),
    (4,'Ramez Elmasri'),
    (5,'Gilbert Strang');

INSERT INTO BORROWER VALUES
    (1,'Aditeya Baral','Bangalore',9686041205),
    (2,'Vishesh P','Bangalore',9679823452),
    (3,'Vinay Kirpalani','New Delhi',9357635468),
    (4,'Aronya Baksy','Kolkata',9757964523),
    (5,'Ansh Sarkar','Mumbai',9753456876);

INSERT INTO LIBRARY_BRANCH VALUES
    (1,'Central Branch','New Delhi'),
    (2,'South Branch','Bangalore'),
    (3,'Global Branch','Mumbai'),
    (4,'East Branch','Kolkata');

INSERT INTO BOOK_COPIES VALUES
    (1,1,100),
    (1,4,150),
    (1,2,150),
    (2,1,10),
    (2,3,200),
    (3,1,350),
    (3,2,400),
    (4,3,50),
    (4,1,120),
    (5,4,10),
    (5,2,300);

INSERT INTO BOOK_LOANS VALUES
    (2,1,1,'2020-02-15',GETDATE()-1),
    (1,2,2,'2020-01-02','2020-02-15'),
    (3,3,3,'2020-03-05',GETDATE()-1),
    (4,4,4,'2020-02-10','2020-04-15'),
    (5,1,5,'2020-01-29','2020-02-28'),
    (1,2,3,'2020-03-01','2020-03-30'),
    (2,3,4,'2020-02-23',GETDATE()-1),
    (2,3,1,'2020-03-02','2020-04-02'),
    (5,1,2,'2020-03-06','2020-03-30');

SELECT * FROM BOOK;
SELECT * FROM PUBLISHER;
SELECT * FROM BOOK_AUTHORS;
SELECT * FROM BOOK_COPIES;
SELECT * FROM BOOK_LOANS;
SELECT * FROM LIBRARY_BRANCH;
SELECT * FROM BORROWER;

/* DELETES ALL TABLES TO START OVER
DECLARE @Sql NVARCHAR(500) DECLARE @Cursor CURSOR
SET @Cursor = CURSOR FAST_FORWARD FOR
SELECT DISTINCT sql = 'ALTER TABLE [' + tc2.TABLE_SCHEMA + '].[' +  tc2.TABLE_NAME + '] DROP [' + rc1.CONSTRAINT_NAME + '];'
FROM INFORMATION_SCHEMA.REFERENTIAL_CONSTRAINTS rc1
LEFT JOIN INFORMATION_SCHEMA.TABLE_CONSTRAINTS tc2 ON tc2.CONSTRAINT_NAME =rc1.CONSTRAINT_NAME
OPEN @Cursor FETCH NEXT FROM @Cursor INTO @Sql
WHILE (@@FETCH_STATUS = 0)
BEGIN
Exec sp_executesql @Sql
FETCH NEXT FROM @Cursor INTO @Sql
END
CLOSE @Cursor DEALLOCATE @Cursor
EXEC sp_MSforeachtable 'DROP TABLE ?'
*/
